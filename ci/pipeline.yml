---
resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:
  - name: git-repo-master
    type: git
    source:
      uri: {{git_repo_url}}
      branch: master
      private_key: {{git_private_key}}
      username: {{github_user}}

  - name: git-repo-dev
    type: git
    source:
      uri: {{git_repo_url}}
      branch: dev
      private_key: {{git_private_key}}
      username: {{github_user}}

  - name: homebrew-repo
    type: git
    source:
      uri: {{homebrew_repo_url}}
      branch: master
      private_key: {{git_private_key}}
      username: {{github_user}}

  - name: app-resource-version
    type: semver
    source:
      driver: git
      initial_version: 0.0.0
      uri: {{git_repo_url}}
      branch: version
      file: version
      private_key: {{git_private_key}}
      username: {{github_user}}

  - name: homebrew-resource-version
    type: semver
    source:
      driver: git
      initial_version: 0.0.0
      uri: {{homebrew_repo_url}}
      branch: version
      file: version
      private_key: {{git_private_key}}
      username: {{github_user}}

  - name: github_release
    type: github-release
    source:
      user: {{github_user}}
      repository: {{git_repo_name}}
      access_token: {{github_token}}

  - name: slack-alert
    type: slack-notification
    source:
      url: {{slack_webook}}

jobs:
  - name: integration
    build_logs_to_retain: 10
    serial: true
    plan:
      - get: git-repo-dev
        trigger: true
      - task: ci
        file: git-repo-dev/ci/integration.yml
        params:
          MAKE_TARGETS: _prepare _test _build
    on_failure:
      put: slack-alert
      params:
        channel: '#ci'
        text: |
          Build $BUILD_NAME. *$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* failed!
          Check it out at:
          https://concourse-ci.correia.io/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME


  - name: release
    build_logs_to_retain: 10
    serial: true
    plan:
      - get: git-repo-master
        trigger: true

      - put: app-resource-version
        params:
          bump: minor

      - task: ci
        file: git-repo-master/ci/release.yml
        params:
          MAKE_TARGETS: _prepare deps _release
          VERSION: app-resource-version

      - put: github-release
        params:
          name: app-resource-version/version
          tag: app-resource-version/version
          globs:
              - output/*tar.gz
      - get: homebrew-repo
        passed: github-release
      - task: homebrew-tap
        file: git-repo-master/ci/release.yml
        params:
          MAKE_TARGETS: homebrew-tap
          VERSION: app-resource-version
      - put: homebrew-repo

    on_failure:
      put: slack-alert
      params:
        channel: '#ci'
        text: |
          Build $BUILD_NAME. *$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* failed!
          Check it out at:
          https://concourse-ci.correia.io/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
    on_success:
      put: slack-alert
      params:
        channel: '#ci'
        text: |
          :white_check_mark: *$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* has a new release.
          Check it out at:
          https://concourse-ci.correia.io/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

